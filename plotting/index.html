<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */

body {
  font-family: sans-serif;
  color: #444;
}

.line {
    fill: none;
    stroke: #ffab00;
    stroke-width: 3;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
.axis text {
  font-size: 10px;
}

div.tooltip {	
    position: absolute;			
    text-align: center;			
    width: 80px;					
    height: 28px;					
    padding: 2px;				
    font: 12px sans-serif;		
    background: lightsteelblue;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
}

</style>
<body>

<h4>Cases in The world</h4>

<label for="cars">Choose a country:</label>

<select id="country" onchange="populateData(this.value)">
  <option value="Afghanistan">Afghanistan</option>
  <option value="Angola">Angola</option>
  <option value="Albania">Albania</option>
  <option value="United Arab Emirates">United Arab Emirates</option>
  <option value="Argentina">Argentina</option>
  <option value="Armenia">Armenia</option>
  <option value="Antarctica">Antarctica</option>
  <option value="French Southern and Antarctic Lands">French Southern and Antarctic Lands</option>
  <option value="Australia">Australia</option>
  <option value="Austria">Austria</option>
  <option value="Azerbaijan">Azerbaijan</option>
  <option value="Burundi">Burundi</option>
  <option value="Belgium">Belgium</option>
  <option value="Benin">Benin</option>
  <option value="Burkina Faso">Burkina Faso</option>
  <option value="Bangladesh">Bangladesh</option>
  <option value="Bulgaria">Bulgaria</option>
  <option value="The Bahamas">The Bahamas</option>
  <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
  <option value="Belarus">Belarus</option>
  <option value="Belize">Belize</option>
  <option value="Bermuda">Bermuda</option>
  <option value="Bolivia">Bolivia</option>
  <option value="Brazil">Brazil</option>
  <option value="Brunei">Brunei</option>
  <option value="Bhutan">Bhutan</option>
  <option value="Botswana">Botswana</option>
  <option value="Central African Republic">Central African Republic</option>
  <option value="Canada">Canada</option>
  <option value="Switzerland">Switzerland</option>
  <option value="Chile">Chile</option>
  <option value="China">China</option>
  <option value="Ivory Coast">Ivory Coast</option>
  <option value="Cameroon">Cameroon</option>
  <option value="Democratic Republic of the Congo">Democratic Republic of the Congo</option>
  <option value="Republic of the Congo">Republic of the Congo</option>
  <option value="Colombia">Colombia</option>
  <option value="Costa Rica">Costa Rica</option>
  <option value="Cuba">Cuba</option>
  <option value="Cyprus">Cyprus</option>
  <option value="Czech Republic">Czech Republic</option>
  <option value="Germany">Germany</option>
  <option value="Djibouti">Djibouti</option>
  <option value="Denmark">Denmark</option>
  <option value="Dominican Republic">Dominican Republic</option>
  <option value="Algeria">Algeria</option>
  <option value="Ecuador">Ecuador</option>
  <option value="Egypt">Egypt</option>
  <option value="Eritrea">Eritrea</option>
  <option value="Spain">Spain</option>
  <option value="Estonia">Estonia</option>
  <option value="Ethiopia">Ethiopia</option>
  <option value="Finland">Finland</option>
  <option value="Fiji">Fiji</option>
  <option value="Falkland Islands">Falkland Islands</option>
  <option value="France">France</option>
  <option value="Gabon">Gabon</option>
  <option value="United Kingdom">United Kingdom</option>
  <option value="Georgia">Georgia</option>
  <option value="Ghana">Ghana</option>
  <option value="Guinea">Guinea</option>
  <option value="Gambia">Gambia</option>
  <option value="Guinea Bissau">Guinea Bissau</option>
  <option value="Equatorial Guinea">Equatorial Guinea</option>
  <option value="Greece">Greece</option>
  <option value="Greenland">Greenland</option>
  <option value="Guatemala">Guatemala</option>
  <option value="French Guiana">French Guiana</option>
  <option value="Guyana">Guyana</option>
  <option value="Honduras">Honduras</option>
  <option value="Croatia">Croatia</option>
  <option value="Haiti">Haiti</option>
  <option value="Hungary">Hungary</option>
  <option value="Indonesia">Indonesia</option>
  <option value="India">India</option>
  <option value="Ireland">Ireland</option>
  <option value="Iran">Iran</option>
  <option value="Iraq">Iraq</option>
  <option value="Iceland">Iceland</option>
  <option value="Israel">Israel</option>
  <option value="Italy">Italy</option>
  <option value="Jamaica">Jamaica</option>
  <option value="Jordan">Jordan</option>
  <option value="Japan">Japan</option>
  <option value="Kazakhstan">Kazakhstan</option>
  <option value="Kenya">Kenya</option>
  <option value="Kyrgyzstan">Kyrgyzstan</option>
  <option value="Cambodia">Cambodia</option>
  <option value="South Korea">South Korea</option>
  <option value="Kuwait">Kuwait</option>
  <option value="Laos">Laos</option>
  <option value="Lebanon">Lebanon</option>
  <option value="Liberia">Liberia</option>
  <option value="Libya">Libya</option>
  <option value="Sri Lanka">Sri Lanka</option>
  <option value="Lesotho">Lesotho</option>
  <option value="Lithuania">Lithuania</option>
  <option value="Luxembourg">Luxembourg</option>
  <option value="Latvia">Latvia</option>
  <option value="Morocco">Morocco</option>
  <option value="Moldova">Moldova</option>
  <option value="Madagascar">Madagascar</option>
  <option value="Mexico">Mexico</option>
  <option value="Macedonia">Macedonia</option>
  <option value="Mali">Mali</option>
  <option value="Myanmar">Myanmar</option>
  <option value="Montenegro">Montenegro</option>
  <option value="Mongolia">Mongolia</option>
  <option value="Mozambique">Mozambique</option>
  <option value="Mauritania">Mauritania</option>
  <option value="Malawi">Malawi</option>
  <option value="Malaysia">Malaysia</option>
  <option value="Namibia">Namibia</option>
  <option value="New Caledonia">New Caledonia</option>
  <option value="Niger">Niger</option>
  <option value="Nigeria">Nigeria</option>
  <option value="Nicaragua">Nicaragua</option>
  <option value="Netherlands">Netherlands</option>
  <option value="Norway">Norway</option>
  <option value="Nepal">Nepal</option>
  <option value="New Zealand">New Zealand</option>
  <option value="Oman">Oman</option>
  <option value="Pakistan">Pakistan</option>
  <option value="Panama">Panama</option>
  <option value="Peru">Peru</option>
  <option value="Philippines">Philippines</option>
  <option value="Papua New Guinea">Papua New Guinea</option>
  <option value="Poland">Poland</option>
  <option value="Puerto Rico">Puerto Rico</option>
  <option value="North Korea">North Korea</option>
  <option value="Portugal">Portugal</option>
  <option value="Paraguay">Paraguay</option>
  <option value="Qatar">Qatar</option>
  <option value="Romania">Romania</option>
  <option value="Russia">Russia</option>
  <option value="Rwanda">Rwanda</option>
  <option value="Western Sahara">Western Sahara</option>
  <option value="Saudi Arabia">Saudi Arabia</option>
  <option value="Sudan">Sudan</option>
  <option value="South Sudan">South Sudan</option>
  <option value="Senegal">Senegal</option>
  <option value="Solomon Islands">Solomon Islands</option>
  <option value="Sierra Leone">Sierra Leone</option>
  <option value="El Salvador">El Salvador</option>
  <option value="Somaliland">Somaliland</option>
  <option value="Somalia">Somalia</option>
  <option value="Republic of Serbia">Republic of Serbia</option>
  <option value="Suriname">Suriname</option>
  <option value="Slovakia">Slovakia</option>
  <option value="Slovenia">Slovenia</option>
  <option value="Sweden">Sweden</option>
  <option value="Swaziland">Swaziland</option>
  <option value="Syria">Syria</option>
  <option value="Chad">Chad</option>
  <option value="Togo">Togo</option>
  <option value="Thailand">Thailand</option>
  <option value="Tajikistan">Tajikistan</option>
  <option value="Turkmenistan">Turkmenistan</option>
  <option value="East Timor">East Timor</option>
  <option value="Trinidad and Tobago">Trinidad and Tobago</option>
  <option value="Tunisia">Tunisia</option>
  <option value="Turkey">Turkey</option>
  <option value="Taiwan">Taiwan</option>
  <option value="United Republic of Tanzania">United Republic of Tanzania</option>
  <option value="Uganda">Uganda</option>
  <option value="Ukraine">Ukraine</option>
  <option value="Uruguay">Uruguay</option>
  <option value="United States of America">United States of America</option>
  <option value="Uzbekistan">Uzbekistan</option>
  <option value="Venezuela">Venezuela</option>
  <option value="Vietnam">Vietnam</option>
  <option value="Vanuatu">Vanuatu</option>
  <option value="West Bank">West Bank</option>
  <option value="Yemen">Yemen</option>
  <option value="South Africa">South Africa</option>
  <option value="Zambia">Zambia</option>
  <option value="Zimbabwe">Zimbabwe</option>
</select>

<svg id="svgLineChart"></svg>
  <select id="dailyDropdown">
      <option value="NewConfirmed" selected="selected">New Confirmed Cases Per Day</option>
      <option value="NewDeaths">New Deaths Per Day</option>
      <option value="NewRecovered">Recovered Patients Per Day</option>
  </select>
<svg id="svgBarGraph">
</svg>
<!-- load the d3.js library -->    	
<!-- <script src="https://d3js.org/d3.v5.min.js"></script> -->
<script src="https://d3js.org/d3.v5.js"></script>
<script>

// set the dimensions and margins of the graph
const margin = {top: 20, right: 20, bottom: 50, left: 70},
    width = 500 - margin.left - margin.right,
    height = 360 - margin.top - margin.bottom;

// parse the date / time
const parseTime = d3.timeParse("%Y-%m-%d");
const formatDateToString = d3.timeFormat("%b %d")

const colors = {
  "Confirmed": "#000000",
  "NewConfirmed": "#000000",
  "Deaths": "#FC0303",
  "NewDeaths": "#FC0303",
  "Recovered": "#00FF00",
  "NewRecovered": "#00FF00"
}

var svgLineChart = d3.select("#svgLineChart")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

var svgBarGraph = d3.select("#svgBarGraph")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

var legendScale = d3.scaleOrdinal()
  .domain(Object.keys(colors))
  .range(Object.values(colors));


var filterDataByCountry = function(data, country){
  data = data.filter(function(d) {
    return d["Country"] ===  country;
  })

  var prevConfirmed, prevDeaths, prevRecovered = 0;

  data.forEach(function(d) {
    d.Date = parseTime(d.Date);
    d.Confirmed = +d.Confirmed;
    d.Deaths= +d.Deaths;
    d.Recovered= +d.Recovered;

    d.NewConfirmed = d.Confirmed - prevConfirmed;
    prevConfirmed = +d.Confirmed;

    d.NewDeaths = d.Deaths - prevDeaths;
    prevDeaths = +d.Deaths;
      
    d.NewRecovered = d.Recovered - prevRecovered;
    prevRecovered = +d.Recovered;
  });


  var daysWithoutIncident = data.filter(function (el) {
    return el.Confirmed == 0 &&
           el.Deaths == 0 &&
           el.Recovered == 0;
  });

  data.splice(0, daysWithoutIncident.length-1);
  return data;
}

var populateData = function(country){
  d3.csv("world_data.csv").then(function(data) {

    data = filterDataByCountry(data, country);

    populateLineChart(data, svgLineChart);
    populateBarGraph(data, svgBarGraph);

    d3.select('.legend-group').remove();
    let group = d3.select("svg").append("g").attr("class","legend-group");

    let legend = group.selectAll(".legend")
      .data(legendScale.domain().slice())
      .enter().append("g")
      .attr("class","legend")
      .attr("transform",function(d,i) {
        return "translate(0," + i * 20 + ")";
      });

    legend.append("rect")
      .attr("x",475)
      .attr("y",65)
      .attr("width",18)
      .attr("height",18)
      .style("fill", legendScale);

    legend.append("text")
      .attr("x",465)
      .attr("y",73)
      .attr("dy",".35em")
      .style("text-anchor","end")
      .text(function(d) { return d; });
})};

var populateLineChart = function(data, svg){
  svg.selectAll("*").remove();
  // set the ranges
  let x = d3.scaleTime().range([0, width]);
  let y = d3.scaleLinear().range([height, 0]);

  // define the line
  let valueline_confirmed = d3.line()
      .x(function(d) { return x(d.Date); })
      .y(function(d) { return y(d.Confirmed); });

  let valueline_deaths = d3.line()
      .x(function(d) { return x(d.Date); })
      .y(function(d) { return y(d.Deaths); });

  let valueline_recovered = d3.line()
      .x(function(d) { return x(d.Date); })
      .y(function(d) { return y(d.Recovered); });

  // Define the div for the tooltip
  let div = d3.select("body").append("div")	
      .attr("class", "tooltip")				
      .style("opacity", 0);

  x.domain(d3.extent(data, function(d) { return d.Date; }));
  y.domain([0, d3.max(data, function(d) { 
    return Math.max(d.Confirmed, d.Recovered, d.Deaths)})]);

  // Add the valueline path.
  svg.append("path")
    .data([data])
    .attr("class", "line")
    .style("stroke", colors["Confirmed"])
    .attr("d", valueline_confirmed);

  svg.append("path")
    .data([data])
    .attr("class", "line")
    .style("stroke", colors["Deaths"])
    .attr("d", valueline_deaths);

  svg.append("path")
    .data([data])
    .attr("class", "line")
    .style("stroke", colors["Recovered"])
    .attr("d", valueline_recovered);

  // Add the x Axis
  svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).ticks(6));

  // Add the y Axis
  svg.append("g")
    .call(d3.axisLeft(y));
  svg.append('text')                                     
    .attr('x', 10)              
    .attr('y', -5)             
    .text('Data taken from https://github.com/datasticslab'); 

  svg.selectAll("dot")	
    .data(data)			
    .enter().append("circle")								
    .attr("r", 5)		
    .attr("cx", function(d) { return x(d.Date); })		 
    .attr("cy", function(d) { return y(d.Confirmed); })		
    .style("fill", colors["Confirmed"])
    .on("mouseover", function(d) {		
      div.transition()		
        .duration(200)		
        .style("opacity", .9);		
      div	.html(formatDateToString (d.Date) + "<br/>"  + d.Confirmed + " Confirmed")	
        .style("left", (d3.event.pageX) + "px")		
        .style("top", (d3.event.pageY - 28) + "px");	
    })					
    .on("mouseout", function(d) {		
      div.transition()		
        .duration(500)		
        .style("opacity", 0);	
    });

  svg.selectAll("dot")	
    .data(data)			
    .enter().append("circle")								
    .attr("r", 5)		
    .attr("cx", function(d) { return x(d.Date); })		 
    .attr("cy", function(d) { return y(d.Deaths); })		
    .style("fill", colors["Deaths"])
    .on("mouseover", function(d) {		
      div.transition()		
        .duration(200)		
        .style("opacity", .9);		
      div	.html(formatDateToString (d.Date) + "<br/>"  + d.Deaths + " Deaths")	
        .style("left", (d3.event.pageX) + "px")		
        .style("top", (d3.event.pageY - 28) + "px");	
    })					
    .on("mouseout", function(d) {		
      div.transition()		
        .duration(500)		
        .style("opacity", 0);	
    });


  svg.selectAll("dot")	
    .data(data)			
    .enter().append("circle")								
    .attr("r", 5)		
    .attr("cx", function(d) { return x(d.Date); })		 
    .attr("cy", function(d) { return y(d.Recovered); })		
    .style("fill", colors["Recovered"])
    .on("mouseover", function(d) {		
      div.transition()		
        .duration(200)		
        .style("opacity", .9);		
      div	.html(formatDateToString (d.Date) + "<br/>"  + d.Recovered + " Recovered")	
        .style("left", (d3.event.pageX) + "px")		
        .style("top", (d3.event.pageY - 28) + "px");	
    })					
    .on("mouseout", function(d) {		
      div.transition()		
        .duration(500)		
        .style("opacity", 0);	
    });

}

d3.select('#dailyDropdown').on("change", function () {
      country = d3.select('#country').node().value;
      d3.csv("world_data.csv").then(function(data) {
        data = filterDataByCountry(data, country);
        v = d3.select('#dailyDropdown').node().value;
        populateBarGraph(data, svgBarGraph, v);
})});

var populateBarGraph = function(data, svg, dailyValue="NewConfirmed"){
  svg.selectAll("*").remove();

  let x = d3.scaleBand()
    .range([0, width])
    .padding(0.1);
  let y = d3.scaleLinear()
    .range([height, 0]);


  x.domain(data.map(function(d) { return d.Date; }));
  y.domain([0, d3.max(data, function(d) {  return d[dailyValue]; })]);

  svg.selectAll(".bar")
    .data(data)
    .enter().append("rect")
    .attr("class", "bar")
    .attr("x", function(d) { return x(d.Date); })
    .attr("width", x.bandwidth())
    .attr("y", function(d) { return y(d[dailyValue]); })
    .attr("height", 0)
    .transition()
    .duration(250)
    .delay(function (d, i) {
      return i * 25;
    })
    .attr("height", function(d) { return Math.max(height - y(d[dailyValue]), 0); })



    .attr("fill", colors[dailyValue]);

  let barX = d3.scaleTime().range([0, width]);
  barX .domain(d3.extent(data, function(d) { return d.Date; }));

  svg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(barX)
                          .ticks(5)
                          .tickFormat(formatDateToString));


  // add the y Axis
  svg.append("g")
    .call(d3.axisLeft(y));
}



    </script>
    </body>
